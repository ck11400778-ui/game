# project/core/ui.py
import os
import pygame
from core.config import COLOR

_FONT = None
_FONT_S = None

# 在這裡列出你優先想用的中文字體名稱（系統字體）
_CJK_CANDIDATES = [
    "Noto Sans CJK TC",
    "Noto Sans TC",
    "Microsoft JhengHei",
    "PingFang TC",
    "PingFang SC",
    "Heiti TC",
    "WenQuanYi Zen Hei",
    "SimHei",
    "Arial Unicode MS",
]

# 專案內的字體路徑（請把 TTF/OTF 丟到這裡）
_PROJECT_FONT_DIR = os.path.join("assets", "fonts")
_PROJECT_FONT_FILES = [
    "NotoSansTC-Regular.otf",
    "NotoSansTC-Regular.ttf",
    "Microsoft JhengHei.ttf",
    "PingFang.ttc",
    "WenQuanYi Zen Hei.ttf",
]

def _find_cjk_font_path():
    """優先找系統字體，找不到再用 assets/fonts/ 裡的檔案。"""
    # 1) 系統字體
    for name in _CJK_CANDIDATES:
        try:
            path = pygame.font.match_font(name)
            if path:
                return path
        except Exception:
            pass
    # 2) 專案字體資料夾
    if os.path.isdir(_PROJECT_FONT_DIR):
        for f in _PROJECT_FONT_FILES:
            p = os.path.join(_PROJECT_FONT_DIR, f)
            if os.path.exists(p):
                return p
        # 若使用者放了不同檔名，也嘗試抓第一個 .ttf/.otf
        for f in os.listdir(_PROJECT_FONT_DIR):
            if f.lower().endswith((".ttf", ".otf", ".ttc")):
                return os.path.join(_PROJECT_FONT_DIR, f)
    return None  # 找不到就交給系統回退（可能不顯示中文）

def init_fonts(size=20, small=16):
    """請在 pygame.init() 後呼叫一次。"""
    global _FONT, _FONT_S
    if _FONT is not None:
        return
    # 確保 font 子系統啟動
    if not pygame.font.get_init():
        pygame.font.init()

    font_path = _find_cjk_font_path()
    try:
        if font_path:
            _FONT = pygame.font.Font(font_path, size)
            _FONT_S = pygame.font.Font(font_path, small)
        else:
            # 萬一真的找不到，就用系統默認（可能無法顯示中文）
            _FONT = pygame.font.SysFont("Arial", size)
            _FONT_S = pygame.font.SysFont("Arial", small)
    except Exception:
        # 保底
        _FONT = pygame.font.SysFont(None, size)
        _FONT_S = pygame.font.SysFont(None, small)

def draw_text(surface, txt, pos, color=COLOR["text"], small=False):
    # 懶載：若沒 init 也嘗試啟動（避免忘記呼叫 init_fonts）
    global _FONT, _FONT_S
    if _FONT is None or _FONT_S is None:
        init_fonts()
    font = _FONT_S if small else _FONT
    img = font.render(str(txt), True, color)
    surface.blit(img, pos)